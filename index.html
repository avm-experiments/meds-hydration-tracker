<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Daily Meds & Hydration Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: #f5f5f7;
      color: #111827;
    }
    h1, h2, h3 { margin: 0 0 8px; }
    h1 { font-size: 20px; font-weight: 700; }
    h2 { font-size: 16px; margin-top: 16px; }
    h3 { font-size: 14px; margin-top: 12px; }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.08);
    }
    .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin: 4px 0;
      flex-wrap: wrap;
    }
    label { font-size: 14px; }
    input, select, button { font-family: inherit; font-size: 14px; }
    input[type="time"], input[type="number"], select {
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      min-width: 90px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      background: #2563eb;
      color: white;
      font-weight: 500;
      cursor: pointer;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button.small-btn {
      padding: 4px 8px;
      font-size: 12px;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .pill {
      display: inline-flex;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5e7eb;
      color: #374151;
      align-items: center;
      gap: 4px;
      margin-top: 2px;
    }
    .pill.ok { background: #dcfce7; color: #166534; }
    .pill.warn { background: #fee2e2; color: #b91c1c; }
    .small { font-size: 12px; color: #6b7280; }
    .stat { font-size: 13px; margin: 2px 0; }
    hr {
      border: none;
      border-top: 1px solid #e5e7eb;
      margin: 8px 0;
    }
  </style>
</head>
<body>
  <h1>Daily Meds & Hydration</h1>

  <!-- DATE / DAY SELECTOR -->
  <div class="row">
    <div class="small" id="todayLabel"></div>
    <div class="row" style="justify-content:flex-end;">
      <label for="daySelect" class="small">Day</label>
      <select id="daySelect">
        <option value="0">Today</option>
        <option value="1">Yesterday</option>
        <option value="2">2 days ago</option>
        <option value="3">3 days ago</option>
      </select>
    </div>
  </div>

  <!-- MEDS -->
  <div class="card">
    <h2>Meds Checklist</h2>
    <div class="small">
      Enter the time you took each med and tap <b>Save</b>. The app checks if it’s in the recommended window.
    </div>

    <!-- Coffee finish time -->
    <div class="row" style="margin-top:6px;">
      <label for="coffeeTime">Coffee finished</label>
      <input type="time" id="coffeeTime">
      <button class="secondary small-btn" onclick="saveCoffeeTime()">Save</button>
    </div>
    <div class="small" id="coffeeInfo" style="margin-bottom:6px;"></div>

    <div id="medsList"></div>
    <button class="secondary" onclick="clearSelectedDayMeds()">Clear this day’s meds</button>
  </div>

  <!-- HYDRATION -->
  <div class="card">
    <h2>Hydration Log</h2>
    <div class="row">
      <label for="hydrationType">Type</label>
      <select id="hydrationType">
        <option>Water</option>
        <option>Coffee</option>
        <option>Gatorade Zero</option>
        <option>Nuun / Electrolyte</option>
        <option>Tea</option>
        <option>Other</option>
      </select>
    </div>
    <div class="row">
      <label for="hydrationAmount">Amount (oz)</label>
      <input type="number" id="hydrationAmount" min="1" max="64" value="8">
      <button onclick="addHydration()">Add</button>
    </div>
    <div class="small" id="todayHydrationSummary"></div>
    <div id="hydrationList" class="small"></div>
    <button class="secondary" onclick="clearSelectedDayHydration()">Clear this day’s hydration</button>
  </div>

  <!-- STATS -->
  <div class="card">
    <h2>Stats</h2>
    <div class="row">
      <label for="rangeSelect">Range</label>
      <select id="rangeSelect" onchange="updateStats()">
        <option value="7">Last 7 days</option>
        <option value="30" selected>Last 30 days</option>
        <option value="365">Last 365 days</option>
        <option value="all">All time</option>
      </select>
    </div>
    <h3>Hydration</h3>
    <div id="hydrationStats"></div>
    <h3>Meds</h3>
    <div id="medStats"></div>
  </div>

  <!-- BACKUP / RESTORE -->
  <div class="card">
    <h2>Backup & Restore</h2>
    <div class="small">
      Export all data to a file (for manual backup or moving to another device). Import restores it.
    </div>
    <div class="row" style="margin-top:8px;">
      <button class="secondary" onclick="exportData()">Download backup</button>
      <button class="secondary" onclick="triggerImport()">Restore from file</button>
    </div>
    <input type="file" id="importFile" accept="application/json" style="display:none" />
    <div class="small" id="backupStatus" style="margin-top:6px;"></div>
  </div>

  <script>
    // --- CONFIG ---

    const HYDRATION_TARGET_OZ = 60;

    const MEDS = [
      { id: 'alendronate', label: 'Alendronate (Sunday AM)', start: '06:00', end: '09:00' },
      { id: 'calcium_am', label: 'Calcium (AM)', start: '08:00', end: '12:00' },
      { id: 'calcium_pm', label: 'Calcium (PM)', start: '14:00', end: '18:00' },
      { id: 'b12', label: 'B12 gummy (AM)', start: '07:00', end: '12:00' },
      { id: 'magtein', label: 'Magtein (midday)', start: '11:00', end: '15:00' },
      { id: 'vitc', label: 'Vitamin C (midday)', start: '11:00', end: '15:00' },
      { id: 'folate', label: 'Folate (midday)', start: '11:00', end: '15:00' },
      { id: 'mag_gly', label: 'Magnesium glycinate (night)', start: '20:00', end: '23:59' }
    ];

    const STORAGE_KEY = 'medHydroLog_v1';
    let dayOffset = 0; // 0 = today, 1 = yesterday, etc.

    // --- UTILITIES ---

    function todayStr() {
      const d = new Date();
      d.setHours(0,0,0,0);
      return d.toISOString().slice(0,10);
    }

    function dateStrFromOffset(offset) {
      const d = new Date();
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() - offset);
      return d.toISOString().slice(0,10);
    }

    function currentDateStr() {
      return dateStrFromOffset(dayOffset);
    }

    function offsetLabel(offset) {
      if (offset === 0) return 'Today';
      if (offset === 1) return 'Yesterday';
      return `${offset} days ago`;
    }

    function formatTime(d) {
      return d.toTimeString().slice(0,5); // HH:MM
    }

    function timeToMinutes(t) {
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    }

    function addMinutesToTimeStr(t, delta) {
      const [h, m] = t.split(':').map(Number);
      let total = h * 60 + m + delta;
      total = ((total % 1440) + 1440) % 1440;
      const hh = String(Math.floor(total / 60)).padStart(2, '0');
      const mm = String(total % 60).padStart(2, '0');
      return `${hh}:${mm}`;
    }

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch (e) {
        console.error(e);
        return {};
      }
    }

    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function getDay(data, dateStr) {
      if (!data[dateStr]) {
        data[dateStr] = { meds: {}, hydration: [], coffeeFinish: null };
      } else {
        if (!('coffeeFinish' in data[dateStr])) {
          data[dateStr].coffeeFinish = null; // backward compatible
        }
      }
      return data[dateStr];
    }

    // --- TIMING LOGIC ---

    function isOnTime(med, timeStr, day) {
      const t = timeToMinutes(timeStr);
      const start = timeToMinutes(med.start);
      const end = timeToMinutes(med.end);

      // Special handling for AM calcium:
      // Only enforce "not too early", and include coffee+1hr if present.
      if (med.id === 'calcium_am') {
        let earliest = start; // default earliest = 08:00

        if (day && day.coffeeFinish) {
          const coffeeBase = timeToMinutes(day.coffeeFinish);
          const afterCoffee = coffeeBase + 60; // coffee + 1 hour
          if (afterCoffee > earliest) {
            earliest = afterCoffee;
          }
        }

        // On-time if taken at or after the earliest allowed time.
        return t >= earliest;
      }

      // Default rule for all other meds: must fall within their basic window.
      let ok = (t >= start && t <= end);
      if (!ok) return false;

      // Extra rules for calcium PM
      if (med.id === 'calcium_pm') {
        // 1) Coffee -> calcium: must be >= coffee + 1 hour, if coffee is logged.
        if (day && day.coffeeFinish) {
          const coffeeBase = timeToMinutes(day.coffeeFinish);
          const minCalciumAfterCoffee = coffeeBase + 60;
          if (t < minCalciumAfterCoffee) {
            return false;
          }
        }

        // 2) Calcium PM must be at least 4 hours after Calcium AM, if AM is logged.
        if (day && day.meds && day.meds['calcium_am'] && day.meds['calcium_am'].time) {
          const amTime = timeToMinutes(day.meds['calcium_am'].time);
          const minPmAfterAm = amTime + 240; // 4 hours = 240 minutes
          if (t < minPmAfterAm) {
            return false;
          }
        }
      }

      return true;
    }

    // --- RENDER CURRENT DAY ---

    function renderCurrentDay() {
      const dateStr = currentDateStr();
      const data = loadData();
      const day = getDay(data, dateStr);

      // Label
      const label = document.getElementById('todayLabel');
      label.textContent = `Viewing: ${dateStr} (${offsetLabel(dayOffset)})`;

      // Coffee UI
      const coffeeInput = document.getElementById('coffeeTime');
      const coffeeInfo = document.getElementById('coffeeInfo');
      if (coffeeInput) {
        coffeeInput.value = day.coffeeFinish || '';
      }
      if (coffeeInfo) {
        if (day.coffeeFinish) {
          const earliest = addMinutesToTimeStr(day.coffeeFinish, 60);
          coffeeInfo.textContent = `Coffee finished at ${day.coffeeFinish}. Earliest calcium: ${earliest}.`;
        } else {
          coffeeInfo.textContent = 'No coffee time logged for this day.';
        }
      }

      // Meds
      const medsDiv = document.getElementById('medsList');
      medsDiv.innerHTML = '';
      MEDS.forEach(med => {
        const row = document.createElement('div');
        row.className = 'row';

        const left = document.createElement('div');
        left.style.flex = '1';
        left.innerHTML = `<div>${med.label}</div>` +
          `<div class="small">Recommended: ${med.start}–${med.end}</div>`;

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.flexDirection = 'column';
        right.style.alignItems = 'flex-end';
        right.style.gap = '4px';

        const inputRow = document.createElement('div');
        inputRow.style.display = 'flex';
        inputRow.style.gap = '4px';
        inputRow.style.alignItems = 'center';

        const timeInputId = `time_${med.id}`;
        const timeInput = document.createElement('input');
        timeInput.type = 'time';
        timeInput.id = timeInputId;
        timeInput.style.minWidth = '90px';

        const medLog = day.meds[med.id];
        if (medLog && medLog.time) {
          timeInput.value = medLog.time;
        }

        const btn = document.createElement('button');
        btn.textContent = 'Save';
        btn.onclick = () => {
          let timeStr = document.getElementById(timeInputId).value;
          if (!timeStr) {
            timeStr = formatTime(new Date());
            document.getElementById(timeInputId).value = timeStr;
          }
          const data2 = loadData();
          const d2 = getDay(data2, currentDateStr());
          const onTime = isOnTime(med, timeStr, d2);
          d2.meds[med.id] = { time: timeStr, onTime };
          saveData(data2);
          renderCurrentDay();
          updateStats();
        };

        inputRow.appendChild(timeInput);
        inputRow.appendChild(btn);

        const info = document.createElement('div');
        info.className = 'small';
        if (medLog) {
          const pill = document.createElement('span');
          pill.className = 'pill ' + (medLog.onTime ? 'ok' : 'warn');
          pill.textContent = medLog.onTime
            ? `On time (${medLog.time})`
            : `Off window (${medLog.time})`;
          info.appendChild(pill);
        }

        right.appendChild(inputRow);
        right.appendChild(info);

        row.appendChild(left);
        row.appendChild(right);
        medsDiv.appendChild(row);
      });

      // Hydration summary + list
      const totalOz = day.hydration.reduce((sum, h) => sum + (h.amountOz || 0), 0);
      const summary = document.getElementById('todayHydrationSummary');
      summary.innerHTML = `This day: <b>${totalOz} oz</b> / ${HYDRATION_TARGET_OZ} oz` +
        (totalOz >= HYDRATION_TARGET_OZ ? ' <span class="pill ok">Target hit</span>' : '');

      const listDiv = document.getElementById('hydrationList');
      listDiv.innerHTML = '';
      if (!day.hydration.length) {
        listDiv.textContent = 'No entries yet.';
      } else {
        day.hydration.forEach((h, index) => {
          const row = document.createElement('div');
          row.className = 'row';
          row.style.alignItems = 'center';

          const left = document.createElement('div');
          left.textContent = `${h.time} – ${h.type} (${h.amountOz} oz)`;

          const right = document.createElement('div');
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Delete';
          delBtn.className = 'secondary small-btn';
          delBtn.onclick = () => {
            const data2 = loadData();
            const d2 = getDay(data2, currentDateStr());
            d2.hydration.splice(index, 1);
            saveData(data2);
            renderCurrentDay();
            updateStats();
          };
          right.appendChild(delBtn);

          row.appendChild(left);
          row.appendChild(right);
          listDiv.appendChild(row);
        });
      }
    }

    // --- COFFEE HANDLING ---

    function saveCoffeeTime() {
      const input = document.getElementById('coffeeTime');
      if (!input) return;
      const val = input.value || null;
      const data = loadData();
      const day = getDay(data, currentDateStr());
      day.coffeeFinish = val;
      saveData(data);
      renderCurrentDay();
      updateStats();
    }

    // --- HYDRATION LOGGING ---

    function addHydration() {
      const type = document.getElementById('hydrationType').value;
      const amount = parseFloat(document.getElementById('hydrationAmount').value || '0');
      if (!amount || amount <= 0) return;

      const data = loadData();
      const day = getDay(data, currentDateStr());
      day.hydration.push({
        type,
        amountOz: amount,
        time: formatTime(new Date())
      });
      saveData(data);
      renderCurrentDay();
      updateStats();
    }

    function clearSelectedDayHydration() {
      if (!confirm('Clear hydration for this day?')) return;
      const data = loadData();
      const day = getDay(data, currentDateStr());
      day.hydration = [];
      saveData(data);
      renderCurrentDay();
      updateStats();
    }

    function clearSelectedDayMeds() {
      if (!confirm('Clear med entries for this day?')) return;
      const data = loadData();
      const day = getDay(data, currentDateStr());
      day.meds = {};
      saveData(data);
      renderCurrentDay();
      updateStats();
    }

    // --- STATS ---

    function updateStats() {
      const rangeVal = document.getElementById('rangeSelect').value;
      const data = loadData();
      const dates = Object.keys(data).sort();

      if (!dates.length) {
        document.getElementById('hydrationStats').innerHTML = '<div class="small">No data yet.</div>';
        document.getElementById('medStats').innerHTML = '<div class="small">No data yet.</div>';
        return;
      }

      const todayDate = new Date(todayStr());
      let cutoff = null;
      if (rangeVal !== 'all') {
        const days = parseInt(rangeVal, 10);
        cutoff = new Date(todayDate);
        cutoff.setDate(cutoff.getDate() - (days - 1));
      }

      const inRangeDates = dates.filter(d => {
        if (!cutoff) return true;
        const dt = new Date(d);
        return dt >= cutoff && dt <= todayDate;
      });

      if (!inRangeDates.length) {
        document.getElementById('hydrationStats').innerHTML = '<div class="small">No data in range.</div>';
        document.getElementById('medStats').innerHTML = '<div class="small">No data in range.</div>';
        return;
      }

      // Hydration stats
      let hydrationTotals = [];
      inRangeDates.forEach(d => {
        const day = data[d];
        const total = (day.hydration || []).reduce((sum, h) => sum + (h.amountOz || 0), 0);
        hydrationTotals.push(total);
      });
      const daysCount = hydrationTotals.length;
      const sumHyd = hydrationTotals.reduce((a,b) => a+b, 0);
      const avgHyd = sumHyd / daysCount;
      const targetDays = hydrationTotals.filter(v => v >= HYDRATION_TARGET_OZ).length;

      const hydStatsDiv = document.getElementById('hydrationStats');
      hydStatsDiv.innerHTML = `
        <div class="stat">Days in range: <b>${daysCount}</b></div>
        <div class="stat">Avg hydration: <b>${avgHyd.toFixed(1)} oz/day</b></div>
        <div class="stat">Days hitting target: <b>${targetDays}</b> (${(targetDays / daysCount * 100).toFixed(0)}%)</div>
      `;

      // Med stats
      let totalMedEvents = 0;
      let onTimeEvents = 0;
      inRangeDates.forEach(d => {
        const day = data[d];
        const meds = day.meds || {};
        Object.values(meds).forEach(m => {
          totalMedEvents += 1;
          if (m.onTime) onTimeEvents += 1;
        });
      });

      const medStatsDiv = document.getElementById('medStats');
      if (!totalMedEvents) {
        medStatsDiv.innerHTML = '<div class="small">No meds logged in this range.</div>';
      } else {
        const pct = (onTimeEvents / totalMedEvents * 100).toFixed(0);
        medStatsDiv.innerHTML = `
          <div class="stat">Meds logged: <b>${totalMedEvents}</b></div>
          <div class="stat">Taken in recommended time window: <b>${onTimeEvents}</b> (${pct}%)</div>
        `;
      }
    }

    // --- BACKUP / RESTORE ---

    function exportData() {
      const data = localStorage.getItem(STORAGE_KEY) || '{}';
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `meds_hydration_backup_${todayStr()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      const status = document.getElementById('backupStatus');
      status.textContent = 'Backup downloaded.';
    }

    function triggerImport() {
      const input = document.getElementById('importFile');
      input.value = '';
      input.click();
    }

    document.getElementById('importFile').addEventListener('change', function (evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const parsed = JSON.parse(e.target.result);
          if (typeof parsed === 'object' && parsed !== null) {
            saveData(parsed);
            renderCurrentDay();
            updateStats();
            document.getElementById('backupStatus').textContent = 'Backup restored successfully.';
          } else {
            document.getElementById('backupStatus').textContent = 'Invalid file format.';
          }
        } catch (err) {
          console.error(err);
          document.getElementById('backupStatus').textContent = 'Error reading backup.';
        }
      };
      reader.readAsText(file);
    });

    // --- INIT ---

    document.addEventListener('DOMContentLoaded', () => {
      const daySelect = document.getElementById('daySelect');
      daySelect.addEventListener('change', () => {
        dayOffset = parseInt(daySelect.value, 10) || 0;
        renderCurrentDay();
        updateStats();
      });

      renderCurrentDay();
      updateStats();
    });
  </script>
</body>
</html>
